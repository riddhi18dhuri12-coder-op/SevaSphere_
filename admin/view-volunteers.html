<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getDatabase, ref, onValue, update, get } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA-z1Zx-0qAj6_FGiclcXFdIjiKSjXlUKw",
  authDomain: "sevasphere-6dce7.firebaseapp.com",
  databaseURL: "https://sevasphere-6dce7-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "sevasphere-6dce7",
  storageBucket: "sevasphere-6dce7.appspot.com",
  messagingSenderId: "930986469572",
  appId: "1:930986469572:web:7c62c3e6ff7c3f90d98191"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const container = document.getElementById("applicationsContainer");

let allEvents = {};
let allApplications = {};
let allUsers = {};
let currentUser = null;
let currentSort = "date-desc";


// üîê AUTH CHECK
onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "admin-login.html";
    return;
  }
  currentUser = user;
  loadData();
});


// üîÑ LOAD DATA
function loadData() {

  onValue(ref(db, "events"), snap => {
    allEvents = snap.val() || {};
    renderApplications();
  });

  onValue(ref(db, "applications"), snap => {
    allApplications = snap.val() || {};
    renderApplications();
  });

  onValue(ref(db, "users"), snap => {
    allUsers = snap.val() || {};
    renderApplications();
  });
}


// üîΩ SORT FUNCTION
function sortApplications(apps, event) {

  if (currentSort === "az") {
    apps.sort((a,b)=> event.title.localeCompare(event.title));
  }

  if (currentSort === "date-desc") {
    apps.sort((a,b)=> b[1].appliedAt - a[1].appliedAt);
  }

  if (currentSort === "date-asc") {
    apps.sort((a,b)=> a[1].appliedAt - b[1].appliedAt);
  }

  if (currentSort === "status") {
    apps.sort((a,b)=> (a[1].status || "").localeCompare(b[1].status || ""));
  }

  return apps;
}


// üñ•Ô∏è RENDER
function renderApplications() {

  if (!currentUser) return;

  container.innerHTML = "";

  Object.entries(allEvents).forEach(([eventId, event]) => {

    // üî• SHOW ONLY EVENTS CREATED BY CURRENT ADMIN
    if (!event.createdBy || event.createdBy !== currentUser.uid) {
      return;
    }

    const eventDiv = document.createElement("div");
    eventDiv.className = "event-block";

    eventDiv.innerHTML = `
      <h3>${event.title}</h3>
    `;

    let eventApps = Object.entries(allApplications)
      .filter(([appId, app]) => app.eventId === eventId);

    if (eventApps.length === 0) {
      eventDiv.innerHTML += "<p>No applications yet.</p>";
    }

    // üîΩ SORT
    eventApps = sortApplications(eventApps, event);

    eventApps.forEach(([appId, app]) => {

      const volunteer = allUsers[app.volunteerId];

      const appCard = document.createElement("div");
      appCard.className = "app-card";

      appCard.innerHTML = `
        <div>
          <span class="name-link"
            onclick="viewProfile('${app.volunteerId}')">
            ${volunteer ? volunteer.name : app.volunteerId}
          </span>
          <div>Status: <b>${app.status || "Pending"}</b></div>
        </div>

        <div>
          <button class="btn accept"
            onclick="updateStatus('${appId}', 'Accepted')">
            Accept
          </button>

          <button class="btn reject"
            onclick="updateStatus('${appId}', 'Rejected')">
            Reject
          </button>
        </div>
      `;

      eventDiv.appendChild(appCard);
    });

    container.appendChild(eventDiv);
  });

}


// üîê SECURE UPDATE
window.updateStatus = async function(appId, status) {

  const appSnap = await get(ref(db, "applications/" + appId));
  const appData = appSnap.val();

  const eventSnap = await get(ref(db, "events/" + appData.eventId));
  const eventData = eventSnap.val();

  if (!eventData.createdBy || eventData.createdBy !== currentUser.uid) {
    alert("Not authorized");
    return;
  }

  await update(ref(db, "applications/" + appId), {
    status: status
  });
};


// üë§ PROFILE
window.viewProfile = function(uid) {
  window.location.href = "../volunteer/profile.html?uid=" + uid;
};


// üîΩ ADD SORT DROPDOWN UI
const sortDiv = document.createElement("div");
sortDiv.style.marginBottom = "20px";

sortDiv.innerHTML = `
<label style="font-weight:600;">Sort By: </label>
<select id="sortSelect">
  <option value="date-desc">Date Applied (Newest)</option>
  <option value="date-asc">Date Applied (Oldest)</option>
  <option value="az">Alphabetical (Event)</option>
  <option value="status">Status</option>
</select>
`;

container.before(sortDiv);

document.getElementById("sortSelect").addEventListener("change", (e)=>{
  currentSort = e.target.value;
  renderApplications();
});

</script>
