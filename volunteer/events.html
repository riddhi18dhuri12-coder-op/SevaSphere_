<!DOCTYPE html>
<html>
<head>
  <title>Smart Events Feed | SevaSphere</title>
</head>

<body style="background:#f4f7fb; font-family:'Segoe UI',sans-serif; padding:30px;">

<!-- HEADER -->
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
  <h2 style="color:#1e6091;">üìÇ Smart Events Feed</h2>
  <button style="background:#1e6091; color:white; padding:10px 18px; border:none; border-radius:8px; cursor:pointer;">
    ‚≠ê View Saved Events
  </button>
</div>

<!-- FILTER SECTION -->
<div style="display:flex; gap:15px; margin-bottom:30px; flex-wrap:wrap;">

  <input id="searchInput" placeholder="Search event name..."
    style="flex:2; padding:12px; border-radius:10px; border:1px solid #ccc;">

  <select id="categoryFilter"
    style="flex:1; padding:12px; border-radius:10px; border:1px solid #ccc;">
    <option value="All">All Categories</option>
    <option value="Tree Plantation">Tree Plantation</option>
    <option value="Cleanliness">Cleanliness</option>
    <option value="Teaching">Teaching</option>
    <option value="Donation Drive">Donation Drive</option>
  </select>

  <select id="cityFilter"
    style="flex:1; padding:12px; border-radius:10px; border:1px solid #ccc;">
    <option value="All">All Cities</option>
  </select>

  <button id="clearBtn"
    style="background:#1e6091; color:white; padding:12px 18px; border:none; border-radius:10px; cursor:pointer;">
    Clear
  </button>

</div>

<!-- EVENTS CONTAINER -->
<div id="eventsContainer"></div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getDatabase, ref, onValue, push, set } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA-z1Zx-0qAj6_FGiclcXFdIjiKSjXlUKw",
  authDomain: "sevasphere-6dce7.firebaseapp.com",
  databaseURL: "https://sevasphere-6dce7-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "sevasphere-6dce7",
  storageBucket: "sevasphere-6dce7.appspot.com",
  messagingSenderId: "930986469572",
  appId: "1:930986469572:web:7c62c3e6ff7c3f90d98191"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const eventsContainer = document.getElementById("eventsContainer");
const searchInput = document.getElementById("searchInput");
const categoryFilter = document.getElementById("categoryFilter");
const cityFilter = document.getElementById("cityFilter");
const clearBtn = document.getElementById("clearBtn");

let allEvents = {};
let allApplications = {};
let currentUser = null;


// AUTH CHECK
onAuthStateChanged(auth, (user) => {
  if (!user) {
    alert("Please login first");
    window.location.href = "volunteer-login.html";
    return;
  }

  currentUser = user;
  loadRealtimeData();
});


// FETCH DATA
function loadRealtimeData() {

  onValue(ref(db, "events"), (snapshot) => {
    allEvents = snapshot.val() || {};
    populateCities();
    renderEvents();
  });

  onValue(ref(db, "applications"), (snapshot) => {
    allApplications = snapshot.val() || {};
    renderEvents();
  });
}


// POPULATE CITY FILTER
function populateCities() {
  const cities = new Set();

  Object.values(allEvents).forEach(event => {
    if (event.location) cities.add(event.location);
  });

  cityFilter.innerHTML = '<option value="All">All Cities</option>';

  cities.forEach(city => {
    cityFilter.innerHTML += `<option value="${city}">${city}</option>`;
  });
}


// RENDER EVENTS
function renderEvents() {

  const searchText = searchInput.value.toLowerCase();
  const selectedCategory = categoryFilter.value;
  const selectedCity = cityFilter.value;

  eventsContainer.innerHTML = "";

  Object.entries(allEvents).forEach(([eventId, event]) => {

    if (
      (selectedCategory !== "All" && event.category !== selectedCategory) ||
      (selectedCity !== "All" && event.location !== selectedCity) ||
      (!event.title.toLowerCase().includes(searchText))
    ) {
      return;
    }

    const alreadyApplied = Object.values(allApplications).some(app =>
      app.eventId === eventId && app.volunteerId === currentUser.uid
    );

    const card = document.createElement("div");
    card.style.background = "white";
    card.style.padding = "20px";
    card.style.marginBottom = "20px";
    card.style.borderRadius = "12px";
    card.style.boxShadow = "0 4px 15px rgba(0,0,0,0.1)";

    card.innerHTML = `
      <h3 style="color:#1e6091;">${event.title}</h3>
      <p><b>Category:</b> ${event.category}</p>
      <p><b>City:</b> ${event.location}</p>
      <p><b>Date:</b> ${event.date} | <b>Time:</b> ${event.time}</p>
      <p><b>NGO:</b> ${event.ngo}</p>
      <p>${event.description}</p>

      <button ${alreadyApplied ? "disabled" : ""}
        style="
          margin-top:10px;
          padding:10px 18px;
          border:none;
          border-radius:8px;
          background:${alreadyApplied ? '#76C893' : '#1e6091'};
          color:white;
          cursor:pointer;
        "
        onclick="applyForEvent('${eventId}')">
        ${alreadyApplied ? "Applied" : "Apply Now"}
      </button>
    `;

    eventsContainer.appendChild(card);
  });

}


// APPLY FUNCTION
window.applyForEvent = async function(eventId) {

  const newAppRef = push(ref(db, "applications"));

  await set(newAppRef, {
    eventId: eventId,
    volunteerId: currentUser.uid,
    status: "Pending",
    appliedAt: Date.now()
  });

  alert("Applied Successfully üéâ");
};


// FILTER EVENTS
searchInput.addEventListener("input", renderEvents);
categoryFilter.addEventListener("change", renderEvents);
cityFilter.addEventListener("change", renderEvents);

clearBtn.addEventListener("click", () => {
  searchInput.value = "";
  categoryFilter.value = "All";
  cityFilter.value = "All";
  renderEvents();
});

</script>

</body>
</html>
